# 兑换码分发系统缺陷修复追踪看板（2026-02-10）

> 用途：作为安全与稳定性修复的唯一跟踪面板。
>
> 数据来源：Claude 审查清单 + 本地代码复核（仅静态核验，未改代码）。

## 1. 看板使用说明

- 复核结论：已确认 / 部分成立 / 疑似误报
- 修复状态：未开始 / 进行中 / 已修复
- 验证状态：未验证 / 已验证
- 推荐流转：已确认 -> 进行中 -> 已修复 -> 已验证

## 2. 总体统计（初始化）

- 问题总数：35
- 复核结果：已确认 29 / 部分成立 5 / 疑似误报 1
- 严重级别分布：CRITICAL 3 / HIGH 8 / MEDIUM 15 / LOW 10

## 3. 里程碑（可勾选）

- [x] M1：完成所有 CRITICAL（#1-#3）修复并验证
- [x] M2：完成所有 HIGH（#4-#11）修复并验证
- [x] M3：完成所有 MEDIUM（#12-#25）修复并验证
- [x] M4：完成所有 LOW（#26-#35）修复并验证
- [ ] M5：完成一次全链路回归（登录/抽奖/商店/游戏/管理端）

---

## 4. CRITICAL 追踪（优先级 P0）

| # | 问题摘要 | 位置 | 复核结论 | 修复状态 | 验证状态 | 负责人 | ETA | 备注 |
|---|---|---|---|---|---|---|---|---|
| 1 | creditQuotaToUser 读改写竞态，可能覆盖并发充值 | src/lib/new-api.ts:240 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | 增加分布式锁串行化同用户充值 |
| 2 | hybrid 降级路径可能导致双重消耗抽奖次数 | src/lib/lottery.ts:942 | 部分成立 | 已修复 | 已验证 | Codex | 2026-02-10 | 改为 hybrid 顶层统一扣次，失败统一回滚 |
| 3 | 老虎机 bet 模式绕过每日积分上限 | src/lib/slot.ts:271 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | bet 奖励按每日上限截断并计入统计 |

## 5. HIGH 追踪（优先级 P1）

| # | 问题摘要 | 位置 | 复核结论 | 修复状态 | 验证状态 | 负责人 | ETA | 备注 |
|---|---|---|---|---|---|---|---|---|
| 4 | 登录接口缺少速率限制，且无 login 规则 | src/app/api/auth/login/route.ts:5 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | 增加 IP + 用户名双维度限流 |
| 5 | 商店直充 uncertain 处理不当，可能白嫖 | src/lib/store.ts:307 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | uncertain 结果不再回滚积分/限购 |
| 6 | 弹珠游戏分数核心依赖客户端提交 | src/lib/game.ts:117 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | 增加服务端异常检测与可疑提交限流 |
| 7 | 记忆游戏把 cardLayout 返回客户端 | src/lib/memory.ts:224 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | 改为服务端翻牌接口，初始/恢复不返回完整布局 |
| 8 | 连连看 hintsUsed 信任客户端值 | src/lib/linkgame-server.ts:427 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | 提示动作入 moves 并由服务端计数 |
| 9 | tryUseExtraSpin 非原子补偿，存在并发异常 | src/lib/kv.ts:880 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | 改为 Lua 原子检查并扣减 |
| 10 | 商店限购 INCR + EXPIRE 非原子 | src/lib/store.ts:253 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | 改为 Lua 原子占位 + TTL |
| 11 | 多个敏感端点缺少速率限制接入 | src/app/api/**/route.ts | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | 已接入 lottery/slot/checkin/store/project/game start&submit |

## 6. MEDIUM 追踪（优先级 P2）

| # | 问题摘要 | 位置 | 复核结论 | 修复状态 | 验证状态 | 负责人 | ETA | 备注 |
|---|---|---|---|---|---|---|---|---|
| 12 | 时序比较未用 timingSafeEqual，且有长度短路 | src/lib/auth.ts:81 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | 改为 timingSafeEqual + 统一长度缓冲比较 |
| 13 | 开发环境硬编码密钥；弱密钥仅告警不阻断 | src/lib/auth.ts:37 | 部分成立 | 已修复 | 已验证 | Codex | 2026-02-10 | 去硬编码密钥；生产弱密钥改为强制阻断 |
| 14 | 无 Session 吊销机制，登出仅清 Cookie | src/lib/auth.ts:123 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | 引入 jti 黑名单与用户级全量吊销时间戳 |
| 15 | addCodesToProject 的 codesCount 读后写竞态 | src/lib/kv.ts:140 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | 改为 Lua 单事务完成导码与 codesCount 增量 |
| 16 | 直充额度预占使用 INCRBY，不支持小数金额 | src/lib/lottery.ts:700 | 部分成立 | 已修复 | 已验证 | Codex | 2026-02-10 | 金额统一按“美分”缩放存储并支持小数预占/回滚 |
| 17 | 抽奖相关随机源使用 Math.random | src/lib/raffle.ts:456 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | raffle 洗牌改为 crypto.randomInt CSPRNG |
| 18 | 卡牌抽取随机源使用 Math.random | src/lib/cards/draw.ts:103 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | 卡牌随机选择改用统一安全随机工具 |
| 19 | 碎片兑换已拥有卡牌仍扣碎片并返回成功 | src/lib/cards/fragments.ts:121 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | 已拥有卡牌返回 already_owned 且不扣碎片 |
| 20 | 商店积分回滚使用 addPoints 造成流水语义混淆 | src/lib/store.ts:329 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | 引入 exchange_refund 流水来源并统一标签展示 |
| 21 | reserveDirectClaim 未同时写项目记录列表 | src/lib/kv.ts:321 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | 预占 Lua 中同步 LPUSH records，消除 crash 丢记录 |
| 22 | 反馈图片上传 access: public | src/lib/feedback-image-storage.ts:108 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | 在 SDK 仅支持 public 前提下改为高熵随机路径+随机后缀，移除路径敏感信息 |
| 23 | new-api PUT 全量更新有字段清空风险 | src/lib/new-api.ts:262 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | PUT 仅覆盖 quota 并过滤 undefined，避免默认值覆盖/清空字段 |
| 24 | raffle 管理端认证逻辑重复且可能行为差异 | src/app/api/admin/raffle/**/route.ts | 部分成立 | 已修复 | 已验证 | Codex | 2026-02-10 | 抽取共享 checkRaffleAdmin，统一为 getAuthUser()+isAdmin 并兼容 session cookie |
| 25 | 多游戏共用同一 daily stats key，读写竞态少计 | src/lib/game.ts:30 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | 新增原子增量统计助手并在五个游戏路径统一接入 |

## 7. LOW 追踪（优先级 P3）

| # | 问题摘要 | 位置 | 复核结论 | 修复状态 | 验证状态 | 负责人 | ETA | 备注 |
|---|---|---|---|---|---|---|---|---|
| 26 | rollbackDirectClaim Lua 条件存在冗余判断 | src/lib/kv.ts:463 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | 移除冗余条件判断，保留等价逻辑 |
| 27 | recordUser 为 GET + SET 读改写，存在竞态 | src/lib/kv.ts:788 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | 改为 Lua 原子读改写并同步 users:all 索引 |
| 28 | getSecondsUntilMidnight 边界可能返回 0 | src/lib/time.ts:24 | 部分成立 | 已修复 | 已验证 | Codex | 2026-02-10 | 返回值下限改为 1，避免 EX 0 边界错误 |
| 29 | Lottery 配置内存缓存 30 秒，多实例不一致 | src/lib/lottery.ts:66 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | 禁用进程内缓存，配置读取统一以 KV 实时值为准 |
| 30 | 老虎机 randomInt 取模存在轻微偏差 | src/lib/slot.ts:82 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | 改为拒绝采样，消除取模偏差 |
| 31 | Match3 客户端自定义 config 攻击面 | src/app/api/games/match3/start/route.ts:19 | 疑似误报 | 已修复 | 已验证 | Codex | 2026-02-10 | 复核确认无客户端 config 入参，判定误报并关闭 |
| 32 | 老虎机失败路径仍触发冷却计时 | src/lib/slot.ts:259 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | 冷却写入改为成功路径提交，失败不再触发冷却 |
| 33 | lottery 前端存在直接 DOM 与未清理 timeout 问题 | src/app/lottery/page.tsx:699 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | 去除直接 DOM 操作，复制反馈改为状态驱动并补全 timeout 清理 |
| 34 | 错误消息中英文混用 | src/app/api/cards/inventory/route.ts:12 | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | inventory 接口错误文案统一为中文 |
| 35 | API 错误响应结构不统一 | src/app/api/**/route.ts | 已确认 | 已修复 | 已验证 | Codex | 2026-02-10 | route.ts 内 {error} 响应统一为 {success:false,message} |

---

## 8. 建议执行顺序（简版）

1. P0（#1-#3）：先修复竞态与绕过上限，阻断资金/积分损失。
2. P1（#4-#11）：统一接入速率限制，修复白嫖链路与并发计数。
3. P2（#12-#25）：补齐会话安全、随机源、数据一致性与审计链路。
4. P3（#26-#35）：修正低危稳定性与接口一致性问题。

---

## 9. 功能优化建议（优先级 P2-P3）

- 状态图例：✅ 已完成 / 🟡 部分完成 / ⬜ 未开始

### 9.1 安全加固

| # | 优化项 | 说明 | 状态 | 备注 |
|---|--------|------|------|------|
| O1 | 统一速率限制中间件 | 创建 HOF 包装器，减少重复代码 | ✅ | 新增 `withUserRateLimit` 并批量接入敏感路由 |
| O2 | Session 黑名单机制 | Redis 存储已吊销 token 的 jti | ✅ | 已落地 jti 黑名单与用户级全量吊销时间戳 |
| O3 | 加密安全随机数模块 | 创建 `src/lib/random.ts` 统一使用 `crypto.randomInt()` | ✅ | 已落地并接入抽奖与卡牌随机流程 |
| O4 | 日志脱敏 | 移除/脱敏所有日志中的用户名信息 | ✅ | 新增 `src/lib/logging.ts`，关键链路日志统一使用 `maskUsername`/`maskUserId` |

### 9.2 代码质量

| # | 优化项 | 说明 | 状态 | 备注 |
|---|--------|------|------|------|
| O5 | 统一错误响应格式 | 全部改为 `{ success, message?, data? }` | ✅ | 已统一 route.ts 中错误响应为 `{ success:false, message }` |
| O6 | 统一管理员认证 | raffle 路由改用 `getAuthUser()` + `isAdmin` | ✅ | 已消除重复 checkAdmin 并统一鉴权入口 |
| O7 | 提取公共中间件 | `withAuth`, `withAdmin`, `withRateLimit` HOF | ✅ | 新增 `src/lib/api-guards.ts` 并接入 admin/config、sync-users、fix-codes-count、store/reset、store 查询接口 |
| O8 | 前端代码规范化 | 修复变量遮蔽、使用 useRef、清理 setTimeout | ✅ | 已在 cards/project/admin/linkgame 等页面补齐定时器清理与 useRef 管理 |

### 9.3 测试覆盖

| # | 优化项 | 说明 | 状态 | 备注 |
|---|--------|------|------|------|
| O9 | 抽奖系统单元测试 | 覆盖 hybrid 模式、降级、回滚场景 | ✅ | 新增 `lottery-auto.test.ts` 覆盖 uncertain/降级/回滚三场景 |
| O10 | 商店系统单元测试 | 覆盖限购、uncertain、回滚场景 | ✅ | 新增 `store.test.ts` 覆盖限购拦截、uncertain 不回滚、失败回滚三场景 |
| O11 | 并发安全测试 | 模拟竞态条件的集成测试 | ✅ | 扩展 `kv.test.ts` 覆盖并发消耗与负余额钳制，验证 Lua 原子路径 |

---

## 10. 新功能建议（优先级 P3-P4）

### 10.1 用户体验增强

| # | 功能 | 说明 | 优先级 | 状态 | 备注 |
|---|------|------|--------|------|------|
| F1 | 站内通知系统 | 推送中奖结果、反馈回复、系统公告 | P3 | ✅ | 已完成首版：通知中心/API + 中奖/反馈回复推送 + 未读管理 |
| F2 | 成就系统 | 首次签到、连续签到、集齐图鉴等成就 | P3 | ⏭️ | 按当前范围本期不做 |
| F3 | 邀请机制 | 邀请码 + 双向奖励 + 防刷 | P4 | ⏭️ | 按当前范围本期不做 |
| F4 | 个人主页 | 展示成就、卡牌收藏、游戏记录 | P4 | ✅ | 已完成首版：`/api/profile/overview` + `/profile` 个人主页展示 |

### 10.2 排行榜增强

| # | 功能 | 说明 | 优先级 | 状态 | 备注 |
|---|------|------|--------|------|------|
| F5 | 全游戏排行榜 | 扩展为所有游戏的排行榜 | P3 | ✅ | 已完成首版：统一聚合层 + 全游戏榜单 API + 排行榜中心页 |
| F6 | 周期性排行榜 | 每周/月排行榜 + 周期奖励 | P3 | ✅ | 已完成首版：周期结算 API + 发奖幂等 + 历史归档 + 失败重试 |
| F7 | 积分总榜 | 累计积分排行 | P4 | ✅ | 已完成首版：累计/本月净增积分榜 API + 前端筛选展示 |
| F8 | 签到连续天数榜 | 签到天数排行 | P4 | ✅ | 已完成首版：连续签到统计榜 API + 前端筛选展示 |

### 10.3 运营功能

| # | 功能 | 说明 | 优先级 | 状态 | 备注 |
|---|------|------|--------|------|------|
| F9 | 管理员仪表盘 | DAU/MAU、兑换量、积分流转图表 | P3 | ✅ | 已完成首版：`/api/admin/dashboard` + `/admin/dashboard` |
| F10 | 异常检测告警 | 单用户积分暴涨等异常检测 | P3 | ✅ | 已完成首版：异常检测、告警列表、处理接口与后台面板 |
| F11 | 活动系统 | 限时双倍积分、稀有卡牌 UP | P4 | ⏭️ | 按当前范围本期不做 |
| F12 | 公告管理 | 管理员发布/编辑/删除公告 | P4 | ✅ | 已完成首版：公告 CRUD + 发布 fan-out 通知 |

---

## 11. 变更日志（每次更新必填）

| 日期 | 操作人 | 变更内容 | 关联问题 | 结果 |
|---|---|---|---|---|
| 2026-02-10 | 初始化 | 创建追踪文档并录入 35 项问题 | #1-#35 | 已建档 |
| 2026-02-10 | Claude | 补充功能优化建议(O1-O11)和新功能建议(F1-F12) | - | 已补充 |
| 2026-02-10 | Codex | 完成 P0 全部与 P1 部分高危修复并通过 lint+test | #1 #2 #3 #4 #5 #8 #9 #10 #11 | 已完成 |
| 2026-02-10 | Codex | 完成 P1 剩余高危修复并通过 lint+test | #6 #7 | 已完成 |
| 2026-02-10 | Codex | 完成 P2 认证安全修复并通过 lint+test | #12 #13 #14 | 已完成 |
| 2026-02-10 | Codex | 完成 P2 并发一致性与直充精度修复并通过 lint+test | #15 #16 #21 | 已完成 |
| 2026-02-10 | Codex | 完成 P2 随机源安全修复并通过 lint+test | #17 #18 | 已完成 |
| 2026-02-10 | Codex | 修复碎片兑换已拥有卡牌扣碎片问题并补充测试，lint+test 通过 | #19 | 已完成 |
| 2026-02-10 | Codex | 修复商店积分回滚流水语义并通过 lint+test | #20 | 已完成 |
| 2026-02-10 | Codex | 修复反馈图片公开链路风险并通过 lint+test | #22 | 已完成 |
| 2026-02-10 | Codex | 修复 new-api 全量 PUT 字段覆盖风险并通过 lint+test | #23 | 已完成 |
| 2026-02-10 | Codex | 统一 raffle 管理端鉴权并通过 lint+test | #24 | 已完成 |
| 2026-02-10 | Codex | 修复多游戏 daily stats 并发少计问题并通过 lint+test，M3 完成 | #25 | 已完成 |
| 2026-02-10 | Codex | 完成 LOW 首批修复并通过 lint+test | #26 #28 #30 #32 | 已完成 |
| 2026-02-10 | Codex | 修复 #27 并完成 #31 误报复核关闭，lint+test 通过 | #27 #31 | 已完成 |
| 2026-02-10 | Codex | 修复 Lottery 配置多实例缓存不一致并通过 lint+test | #29 | 已完成 |
| 2026-02-10 | Codex | 修复 cards inventory 文案中英文混用并通过 lint+test | #34 | 已完成 |
| 2026-02-10 | Codex | 修复 lottery 前端 DOM/timeout 问题并通过 lint+test | #33 | 已完成 |




| 2026-02-10 | Codex | 完成 O8 前端定时器规范化（useRef + clearTimeout）并通过 lint+test | O8 | 已完成 |
| 2026-02-11 | Codex | 完成 O9 抽奖 hybrid 场景测试覆盖并通过 lint+test（新增 3 条用例） | O9 | 已完成 |
| 2026-02-11 | Codex | 完成 O10 商店关键链路测试覆盖并通过 lint+test（新增 3 条用例） | O10 | 已完成 |
| 2026-02-11 | Codex | 完成 O11 并发安全测试覆盖并通过 lint+test（新增 2 条并发原子性用例） | O11 | 已完成 |
| 2026-02-11 | Codex | 完成新功能路线图规划（排除 F2/F3/F11），并回写 F 状态为可执行计划 | F1 F4 F5 F6 F7 F8 F9 F10 F12 | 已完成 |
| 2026-02-11 | Codex | 完成 M6 首版功能开发与验证（F1/F12），并通过 lint+test | F1 F12 | 已完成 |
| 2026-02-11 | Codex | 完成 M7 首版功能开发与验证（F5/F7/F8），并通过全量 `npm test`（24 files / 201 tests） | F5 F7 F8 | 已完成 |
| 2026-02-11 | Codex | 完成 M8 首版功能开发与验证（F6：周期榜结算/奖励/归档/重试），并通过全量 `npm test`（27 files / 208 tests） | F6 | 已完成 |
| 2026-02-11 | Codex | 完成 M9 首版功能开发与验证（F4/F9/F10：个人主页 + 仪表盘 + 告警闭环），并通过 `npm run lint` + 全量 `npm test` | F4 F9 F10 | 已完成 |

