# 兑换码项目直充额度_20260125

## 目标
在现有“兑换码项目(Project)”模块中新增一种可选的“直充项目”：
- 管理员创建项目时可设置**金额**与**限领人数**
- 用户点击“立即领取”后，系统将金额**直充到用户 new-api 账户余额(quota)**，并在前端提示“领取成功，已直充…”

## 边界（最小修改原则）
- 仅改动“兑换码项目(Project)”相关：`/projects`、`/project/[id]`、项目管理后台、对应 API 与 KV 逻辑
- 不改动积分商店、抽奖、签到等模块
- 直充能力复用已有实现：`src/lib/new-api.ts` 的 `creditQuotaToUser(userId, dollars)`

## 现状检索结论（代码锚点）
- 项目创建（后台）：`src/app/api/admin/projects/route.ts`
- 项目详情/追加兑换码（后台）：`src/app/api/admin/projects/[id]/route.ts`
- 用户查看/领取：`src/app/api/projects/[id]/route.ts` → `src/lib/kv.ts` `claimCode()`
- KV 数据结构：`src/lib/kv.ts` `Project`、`ClaimRecord`、`claimCode()`（Lua 原子领取 + RPOP 兑换码）
- 前端页面：
  - 用户：`src/app/page.tsx`、`src/app/projects/page.tsx`、`src/app/project/[id]/page.tsx`
  - 后台：`src/app/admin/page.tsx`、`src/app/admin/project/[id]/page.tsx`

## 待确认问题（请回复选项；回复“开始执行”后再动代码）
1) **金额语义**：你要设置的是每人固定金额，还是总金额按人数分摊？
   - A. 每人固定金额（推荐，改动最小）
   - B. 总金额均分到每个名额（需要计算与展示单份金额）
   - C. 总金额随机分配（需要随机算法与审计口径，改动较大）

2) **直充项目是否还需要上传兑换码文件？**
   - A. 不需要（推荐）：直充项目不上传兑换码，领取时直接发放
   - B. 仍需上传：领取时“直充 + 同时发兑换码”（双奖励）
   - C. 兼容两种：一个项目可配置为“直充/兑换码/两者都有”

3) **直充失败/不确定(uncertain)时的处理策略**（避免双重发放风险）
   - A. 明确失败：回滚名额，允许用户重试（推荐）；结果不确定：锁定名额并提示“请稍后查余额/联系管理员”
   - B. 明确失败也不回滚名额（实现更简单，但体验差）
   - C. 失败也回滚，但不确定也回滚（有重复发放风险，不推荐）

已确认：1A / 2A / 3A；并要求直充项目支持“追加名额”（不影响已领取用户）。

## 实施清单（执行阶段会逐项勾选）
- [x] 扩展 `Project`：支持区分“兑换码/直充”类型，并存储直充金额
- [x] 扩展 `ClaimRecord`：能记录直充金额与直充状态（成功/失败/不确定）
- [x] 后台创建项目：新增类型选择与金额输入；API 端校验并落库
- [x] 用户领取逻辑：在 KV 原子“占位/防重复/限额”后调用 `creditQuotaToUser`，并按结果落记录与回滚策略
- [x] 用户前端展示：直充项目领取成功弹出“已直充”文案；已领取时展示直充信息（不再展示兑换码复制）
- [x] 后台记录展示：直充项目的记录列表展示金额与状态（必要时显示“不确定”用于人工核对）
- [x] 直充项目追加名额：后台追加人数（不影响已领取用户）
- [x] 验证：`npm run build`（通过）；`npm run lint`（仓库既有问题未通过）
