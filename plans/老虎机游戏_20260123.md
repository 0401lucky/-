# 老虎机游戏（🎰）开发计划 - 2026-01-23

## 目标
- 在 `游戏中心` 上线可玩的“老虎机”小游戏（移动端优先），用于获取积分（遵守每日积分上限）。
- 玩法简单、后端可验证、防刷、可记录历史，保持现有工程风格（Next.js App Router + Vercel KV）。

## 非目标（本期不做）
- 管理后台可配置赔率/符号/主题（纳入后续扩展清单）。
- 音效/震动/多语言/复杂特效（纳入后续扩展清单）。
- 全站排行榜（纳入后续扩展清单；本期先做个人历史 + 复用现有“今日积分/局数”统计）。

## 需求确认（待你选择）
1) 老虎机定位
- A. 赚积分（每次旋转根据结果获得 0~N 积分，受 `dailyPointsLimit` 限制）【推荐】
- B. 赌积分（每次旋转消耗积分，可能赢回更多/亏损）【风险较高：影响商店经济与用户体验】

2) 结构
- A. 3 轴 1 行（经典三格）【推荐：实现最小、移动端体验好】
- B. 3 轴 3 行（含多条 paylines）

3) 玩法节奏
- 单次旋转冷却：`1.5s` 或 `2s`（防刷）【推荐 1.5s】
- 每次旋转动画：`~1.2s`（移动端不拖沓）

4) 默认符号与奖励（可改）
- 符号（6 个）：🍒 🍋 🍇 ⭐ 💎 7️⃣【推荐：经典】
- 计分（示例，待确认）：  
  - 三连：🍒=20、🍋=40、🍇=60、⭐=100、💎=200、7️⃣=400（稀有）  
  - 二连：10（任意两连）  
  - 其他：0

## 已确认选择（默认按推荐执行）
- 定位：1A（赚积分）
- 结构：2A（3 轴 1 行）
- 冷却：`1.5s`（服务端实现按 ~1.5s，客户端交互同口径）
- 奖励表：4A（使用上述默认表）
- 视觉主题：5B（现代极简，贴合现有页面风格）

## 实施清单（勾选式）
- [x] 访谈确认：定位/赔率/冷却/是否需要排行榜
- [x] 新增老虎机前端页：`src/app/games/slot/page.tsx`
- [x] 新增老虎机后端逻辑：`src/lib/slot.ts`
- [x] 新增 API：`src/app/api/games/slot/status/route.ts`、`src/app/api/games/slot/spin/route.ts`
- [x] 接入积分：复用 `addGamePointsWithLimit` + 更新共享 `game:daily:*` 统计
- [x] 记录历史：每用户保留最近 N 条（默认 50）用于 UI 展示
- [x] 游戏中心上架：`src/app/games/page.tsx` 将老虎机 `available: true` 并跳转 `/games/slot`
- [x] 响应式与无障碍：移动端布局、按钮可触达、键盘操作/ARIA 基础
- [ ] 验证与部署：本地 `npm run build` → `git push origin main`（Vercel 自动部署）

## 验收标准
- 移动端可完整游玩：旋转、动画、结果提示、历史记录、积分余额刷新。
- 后端不信任客户端：结果由服务端生成并发放积分；重复点击/并发请求不会无限刷（有 cooldown）。
- 不突破每日积分上限：达到上限后仍可旋转但不再发放积分（与现有游戏一致）。

## 后续扩展清单（计划 / Backlog）
> 说明：以下均为“好扩展但非本期必需”，先纳入计划，等本期 MVP 上线稳定后再逐项推进。

### 1) 管理后台配置化（赔率/符号/主题）
- [ ] KV 配置：新增老虎机专用配置 Key（符号集合、奖励表、冷却、动画时长等）
- [ ] 管理页面：在 `/admin` 下新增老虎机配置页（表单化编辑、保存、回滚/重置默认）
- [ ] 管理 API：新增 `/api/admin/games/slot/config`（GET/POST）用于读写配置
- [ ] 灰度策略：支持“仅管理员可见/小流量开关”，降低改动风险

### 2) 体验增强（音效/震动/更丰富特效）
- [ ] 音效：旋转/停轮/中奖音效（可开关，默认关闭或遵循用户偏好）
- [ ] 震动：移动端 `navigator.vibrate()` 轻反馈（可开关）
- [ ] 特效：大额中奖彩带/金币雨、连胜/幸运值提示（不影响性能为前提）

### 3) 多语言（i18n）
- [ ] 文案抽离：将老虎机页与游戏中心相关文案集中管理（便于翻译）
- [ ] i18n 方案选型：优先不引入重依赖；如需再评估 `next-intl` 等方案
- [ ] 语言切换：记忆用户选择（cookie/localStorage）并在移动端可触达

### 4) 全站排行榜（社区玩法）
- [ ] 榜单口径：按“今日总赢分/最高单次赢分/连胜次数”等维度定义
- [ ] 数据结构：使用 `ZSET`（`kv.zincrby`）维护日榜/周榜，保留 TTL
- [ ] API：新增 `/api/games/slot/ranking`（支持 limit、date、period）
- [ ] UI：在老虎机页或游戏中心展示“今日欧皇榜”（轻量轮询、避免过度请求）
