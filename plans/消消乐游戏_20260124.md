# 消消乐游戏（🧩）开发计划 - 2026-01-24

## 目标
- 在 `游戏中心` 上线一个可玩的“消消乐（Match-3）”小游戏（移动端优先），游玩可获得积分（遵守系统 `dailyPointsLimit` 上限）。
- 复用现有工程能力：Next.js App Router + Vercel KV + 现有积分系统（`addGamePointsWithLimit`）与共享“今日统计（game:daily:*）”。
- 口径清晰、可验收：玩法闭环（开始→游玩→结算→加分→记录历史→回到游戏中心）。
- UI 约束：不使用 Emoji 图标，统一使用 `lucide-react` 图标组件。

## 非目标（本期不做）
- 关卡/地图/体力系统、道具商店、可运营的关卡配置后台。
- 复杂特效（粒子/骨骼动画）、音效包、多人对战。
- 深度反作弊（设备指纹、行为风控）——本期以“服务端复算校验”满足基础可信。

## 项目现状（检索结论）
- 已有游戏中心：`src/app/games/page.tsx`，已上线弹珠机/老虎机/记忆卡片。
- 已有积分系统：`src/lib/points.ts`（Lua 原子发放 + 每日上限），并在各游戏后端复用。
- 已有游戏模式模板：
  - 弹珠机：`src/lib/game.ts` + `/api/games/pachinko/*`
  - 记忆卡：`src/lib/memory.ts` + `/api/games/memory/*`
  - 老虎机：`src/lib/slot.ts` + `/api/games/slot/*`
- 共同特征：会话（seed + TTL）→ 结果提交（幂等锁）→ 服务端校验/计分 → `addGamePointsWithLimit` → 更新共享 `game:daily:*` → 记录历史（list 保留 50 条）。

## 需求确认（待你选择）
1) 玩法类型
- A. 经典 Match-3：交换相邻方块，凑 3+ 消除，连锁下落继续消除【推荐】
- B. 点击消除（同色连通）/泡泡龙类（非交换）

2) 局制（影响节奏与计分）
- A. 限时模式：每局 `60s`，时间到结算【推荐：更适合“赚积分”定位】
- B. 限步模式：例如 `30 步`，用完结算

3) 计分与积分（建议与现有游戏量级接近）
- A. 积分=得分（服务端复算得分后直接发放，受每日上限截断）【推荐：与现有一致】
- B. 积分=固定值/分段（例如完成一局固定 +50，连消额外加成）

4) 规则复杂度（MVP 建议简单）
- A. 仅基础消除（3+ 消除，连锁）【推荐：实现最小、易校验】
- B. 含特殊方块（4连/5连生成特效块、炸弹、彩虹等）

5) 服务端可信度（影响开发量）
- A. 服务端可复算：session seed + 操作序列 → 服务端模拟并得出分数【推荐：与现有风格一致】
- B. 客户端上报分数：快速但可被刷分（不推荐）

## 已确认选择（你已回复）
- 玩法类型：1A（经典交换三消）
- 局制：2A（限时 60s）
- 积分与校验：3A（积分=得分，服务端复算）

## UI/图标约束（你已回复）
- 不使用 Emoji 图标：游戏中心卡片与消消乐页面内的“图标型元素”统一使用 `lucide-react`。
- 说明：功能性图标用 Lucide；普通文案中若出现表情符号将统一移除或替换为同义 Lucide 图标。

## 默认执行（按已确认口径落地）
- 玩法：经典交换式 Match-3
- 局制：限时 60s
- MVP 规则：基础消除 + 连锁下落（不做特殊方块）
- 计分：得分=积分（目标单局约 100~400 分，避免极端爆表）
- 可信：服务端复算（seed + moves），并加最小对局时长与冷却

## 实施清单（勾选式）
- [x] 访谈确认：玩法/局制/计分口径
- [ ] 新增消消乐前端页：`src/app/games/match3/page.tsx`（移动端优先）
- [ ] 新增消消乐前端组件/引擎（纯 TS，可与服务端复用）：`src/app/games/match3/*`
- [ ] 新增消消乐后端逻辑：`src/lib/match3.ts`（会话、校验、计分、记录）
- [ ] 新增 API：`src/app/api/games/match3/status/route.ts`、`start/route.ts`、`submit/route.ts`、`cancel/route.ts`
- [ ] 接入积分：复用 `addGamePointsWithLimit` + 更新共享 `game:daily:*` 统计
- [ ] 游戏中心上架：`src/app/games/page.tsx` 增加“消消乐”入口（`available: true`）
- [ ] 验证：`npm run build` 通过；关键逻辑加最小化单测（如引擎复算一致性）

## 验收标准
- 登录用户可进入 `/games/match3` 游玩；结束后能看到得分/本局获得积分/今日积分进度。
- 达到每日积分上限后仍可游玩但不再发放积分（与现有游戏一致），并有清晰提示。
- 服务端不信任客户端：提交结果会做基本校验（会话有效、幂等、防短时刷、复算得分）。
- 失败场景可恢复：网络错误/重复提交不会重复加分；会话过期给出明确提示。

## 后续扩展清单（Backlog）
- 特殊方块与更强连锁玩法（4连条纹、5连彩虹、炸弹）。
- 多模式：限步、挑战模式（消耗积分换更高上限倍率）、每日任务。
- 轻量榜单：今日最高分/连消次数（KV ZSET）。
