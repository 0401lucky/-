# 反馈墙（意见墙）功能规划 - 2026-02-09

## 目标

- 新增“反馈墙”能力：站内用户可提交反馈，并查看自己的反馈记录。
- 管理员可查看全量反馈并进行处理（状态流转 / 回复）。
- 严格权限隔离：普通用户只能看到自己提交的数据，管理员可见全部。
- 入口放在顶部导航显眼位置，提升可达性。

## 已确认决策

1. 是否支持追加留言
   - 选择：B（支持简易双向留言）
2. 管理员回复是否对用户可见
   - 选择：A（可见）
3. 是否允许匿名提交
   - 选择：A（不允许，必须登录）
4. 用户是否可删除自己反馈
   - 选择：A（不允许）

## 边界（最小修改原则）

- 本期不做公开社区墙（不对其他用户可见）。
- 本期不做通知系统（邮件 / 站内消息推送）。
- 本期不做复杂审核流（多级审批、AI 审核等）。

## 现状代码锚点（复用现有模式）

- 认证与管理员判断：`src/lib/auth.ts`
- 用户端 API 风格：`src/app/api/store/route.ts`、`src/app/api/points/route.ts`
- 管理端 API 风格：`src/app/api/admin/users/route.ts`
- 管理页导航与入口：`src/app/admin/page.tsx`
- 速率限制：`src/lib/rate-limit.ts`
- KV 访问风格：`src/lib/kv.ts`

## 方案设计（推荐实现）

### 1) 数据模型（KV）

反馈主单：

```ts
interface FeedbackItem {
  id: string;
  userId: number;
  username: string;
  contact?: string;
  status: "open" | "processing" | "resolved" | "closed";
  createdAt: number;
  updatedAt: number;
}
```

留言消息：

```ts
interface FeedbackMessage {
  id: string;
  feedbackId: string;
  role: "user" | "admin";
  content: string;
  createdAt: number;
  createdBy: string;
}
```

KV Key 设计：

- `feedback:item:{id}` -> FeedbackItem
- `feedback:list` -> 全量反馈 ID（倒序）
- `feedback:user:{userId}` -> 用户反馈 ID（倒序）
- `feedback:messages:{feedbackId}` -> 反馈会话消息列表（倒序）

### 2) 权限矩阵

- 普通用户：
  - 可创建反馈
  - 可查看自己的反馈列表与详情
  - 可在自己的反馈下继续留言
  - 不可查看他人反馈
- 管理员：
  - 可查看全量反馈
  - 可更新状态
  - 可回复留言

### 3) API 设计

用户端：

- `POST /api/feedback`（创建反馈 + 首条用户消息）
- `GET /api/feedback?page=1&limit=20`（我的反馈列表）
- `GET /api/feedback/[id]`（我的反馈详情 + 消息）
- `POST /api/feedback/[id]/messages`（我的反馈追加留言）

管理端：

- `GET /api/admin/feedback?page=1&limit=50&status=open`（全量列表）
- `GET /api/admin/feedback/[id]`（详情 + 消息）
- `PATCH /api/admin/feedback/[id]`（状态流转）
- `POST /api/admin/feedback/[id]/messages`（管理员回复）

### 4) 页面设计

- 用户页：`/feedback`
  - 提交反馈表单
  - 我的反馈列表
  - 反馈详情与对话区

- 管理页：`/admin/feedback`
  - 全量反馈列表（状态筛选）
  - 详情与对话
  - 状态更新与回复

- 导航入口：
  - 在顶部导航显眼位置新增“反馈墙”入口（用户可见）
  - 在管理员导航中新增“反馈墙”入口（管理页）

### 5) 约束与风控

- 速率限制：用户提交与留言限频（防刷）
- 输入校验：内容长度、空白过滤
- 输出安全：仅文本渲染，不渲染 HTML

### 6) 测试最小集

- 权限测试：普通用户访问管理员接口应 403
- 隔离测试：用户 A 不能读用户 B 的反馈
- 交互测试：用户留言 / 管理员回复 / 状态更新可闭环

## 实施清单（执行阶段逐项勾选）

- [x] 新增反馈数据层 `src/lib/feedback.ts`
- [x] 新增用户端 API（创建 / 列表 / 详情 / 留言）
- [x] 新增管理端 API（列表 / 详情 / 状态更新 / 回复）
- [x] 新增用户页 `src/app/feedback/page.tsx`
- [x] 新增管理页 `src/app/admin/feedback/page.tsx`
- [x] 顶部导航新增显眼入口（用户端）
- [x] 管理端导航新增入口
- [x] 补充测试
- [x] 本地验证：`npm run test` / `npm run lint` / `npm run build`

## 2026-02-09 扩展方案（三步）

- [x] 第一步：真实分页 + 前端“加载更多”（用户端/管理端）
- [x] 第二步：按状态/用户索引化，避免列表全量扫描
- [x] 第三步：自动归档长期关闭工单（默认仅展示活跃工单）
- [x] 第三步补充：管理端可切换查看“已归档”反馈
- [ ] 下一阶段：图片外链化（对象存储），降低 KV 存储与带宽压力

---

等待指令：开始执行
