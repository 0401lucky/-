# å¼¹ç æœºæ¸¸æˆè®¾è®¡æ–‡æ¡£

> ç‰ˆæœ¬: 1.0  
> æ›´æ–°æ—¥æœŸ: 2026-01-21

---

## ä¸€ã€æ¦‚è¿°

### 1.1 åŠŸèƒ½ç®€ä»‹

ç¦åˆ©ç«™æ–°å¢ **å¼¹ç æœºå°æ¸¸æˆ**ï¼Œç”¨æˆ·é€šè¿‡æ¸¸ç©è·å¾—ç§¯åˆ†ï¼Œç§¯åˆ†å¯åœ¨ç§¯åˆ†å•†åº—å…‘æ¢æŠ½å¥–æ¬¡æ•°æˆ–ç›´å……é¢åº¦ã€‚

### 1.2 æ ¸å¿ƒå‚æ•°

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| æ¯å±€å¼¹ç æ•° | 5 é¢— | ç”¨æˆ·æ‰‹åŠ¨é€é¢—å‘å°„ |
| å‘å°„æ–¹å¼ | æ‰‹åŠ¨æ§åˆ¶ | è°ƒæ•´è§’åº¦ + åŠ›åº¦ |
| æ¯æ—¥ç§¯åˆ†ä¸Šé™ | 1000 | é˜²åˆ·æ ¸å¿ƒé™åˆ¶ |
| å±€é—´å†·å´ | 5 ç§’ | éšè—å¼ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥ |
| å•å±€æœ€çŸ­æ—¶é•¿ | 10 ç§’ | é˜²è„šæœ¬æ ¡éªŒ |

### 1.3 ç§¯åˆ†ç»æµ

| å…‘æ¢é¡¹ | ç§¯åˆ†æ¶ˆè€— | è¯´æ˜ |
|--------|----------|------|
| æŠ½å¥–æ¬¡æ•° Ã—1 | 100 ç§¯åˆ† | æ¯æ—¥å¯èµš 10 æ¬¡ |
| é¢åº¦ $1 | 500 ç§¯åˆ† | æ¯æ—¥å¯èµš $2 |

---

## äºŒã€æ¸¸æˆè§„åˆ™

### 2.1 æ¸¸æˆç•Œé¢å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚     å‰©ä½™å¼¹ç : â— â— â— â—‹ â—‹           ä»Šæ—¥ç§¯åˆ†: 425/1000        â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚                         â—  â† å¾…å‘å°„å¼¹ç                       â”‚
â”‚                        â•±â•²                                   â”‚
â”‚                       â•±  â•² â† ç„å‡†çº¿                         â”‚
â”‚                      â•±    â•²                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚                                                 â”‚     â”‚
â”‚     â”‚    Â·    Â·    Â·    Â·    Â·    Â·    Â·    Â·    Â·    â”‚     â”‚ â† é’‰å­å±‚ 1
â”‚     â”‚      Â·    Â·    Â·    Â·    Â·    Â·    Â·    Â·       â”‚     â”‚ â† é’‰å­å±‚ 2
â”‚     â”‚    Â·    Â·    Â·    Â·    Â·    Â·    Â·    Â·    Â·    â”‚     â”‚ â† é’‰å­å±‚ 3
â”‚     â”‚      Â·    Â·    Â·    Â·    Â·    Â·    Â·    Â·       â”‚     â”‚ â† é’‰å­å±‚ 4
â”‚     â”‚    Â·    Â·    Â·    Â·    Â·    Â·    Â·    Â·    Â·    â”‚     â”‚ â† é’‰å­å±‚ 5
â”‚     â”‚      Â·    Â·    Â·    Â·    Â·    Â·    Â·    Â·       â”‚     â”‚ â† é’‰å­å±‚ 6
â”‚     â”‚    Â·    Â·    Â·    Â·    Â·    Â·    Â·    Â·    Â·    â”‚     â”‚ â† é’‰å­å±‚ 7
â”‚     â”‚      Â·    Â·    Â·    Â·    Â·    Â·    Â·    Â·       â”‚     â”‚ â† é’‰å­å±‚ 8
â”‚     â”‚                                                 â”‚     â”‚
â”‚     â”œâ”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â”¤     â”‚
â”‚     â”‚5 â”‚10â”‚20â”‚40â”‚80â”‚40â”‚20â”‚10â”‚5 â”‚     â”‚ â† å¾—åˆ†æ§½ä½
â”‚     â””â”€â”€â”´â”€â”€â”´â”€â”€â”´â”€â”€â”´â”€â”€â”´â”€â”€â”´â”€â”€â”´â”€â”€â”´â”€â”€â”˜     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                                             â”‚
â”‚    â—€â•â•â•â•â•â•â•â•â•â•â•â•â—â•â•â•â•â•â•â•â•â•â•â•â•â–¶   åŠ›åº¦: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 80%       â”‚
â”‚              [å‘å°„]                                         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ§½ä½åˆ†å€¼è®¾è®¡

```
ä½ç½®:    1    2    3    4    5    4    3    2    1
åˆ†å€¼:   [5]  [10] [20] [40] [80] [40] [20] [10] [5]
         â†‘                   â†‘                   â†‘
       è¾¹ç¼˜                 ä¸­å¿ƒ                è¾¹ç¼˜
       (æ˜“)                (éš¾)                (æ˜“)
```

**å¾—åˆ†é¢„ä¼°ï¼ˆ5é¢—å¼¹ç ï¼‰ï¼š**

| æƒ…å†µ | åˆ†æ•° | æ¦‚ç‡ |
|------|------|------|
| æœ€ä½ | 25 åˆ† | æä½ï¼ˆ5Ã—5ï¼Œå…¨è¾¹ç¼˜ï¼‰ |
| è¾ƒä½ | 40-60 åˆ† | çº¦ 20% |
| å¹³å‡ | 80-120 åˆ† | çº¦ 50% |
| è¾ƒé«˜ | 150-200 åˆ† | çº¦ 25% |
| æœ€é«˜ | 400 åˆ† | æä½ï¼ˆ5Ã—80ï¼Œå…¨ä¸­å¿ƒï¼‰ |

**è®¾è®¡ç†å¿µï¼š**
- ä¸­å¿ƒæ§½ä½åˆ†å€¼æœ€é«˜ï¼ˆ80ï¼‰ï¼Œä½†å¼¹ç ç»è¿‡å¤šå±‚é’‰å­åè½å…¥ä¸­å¿ƒçš„æ¦‚ç‡è¾ƒä½
- è¾¹ç¼˜æ§½ä½åˆ†å€¼ä½ï¼ˆ5ï¼‰ï¼Œä½†æ›´å®¹æ˜“è½å…¥
- ç©å®¶å¯é€šè¿‡è°ƒæ•´å‘å°„è§’åº¦å’ŒåŠ›åº¦ï¼Œå°è¯•æ§åˆ¶å¼¹ç è½¨è¿¹

### 2.3 æ‰‹åŠ¨å‘å°„äº¤äº’

**æ“ä½œæ–¹å¼ï¼š**

| æ“ä½œ | æ•ˆæœ | èŒƒå›´ |
|------|------|------|
| å·¦å³æ»‘åŠ¨/æ‹–åŠ¨ | è°ƒæ•´å‘å°„è§’åº¦ | -30Â° ~ +30Â° |
| ä¸Šä¸‹æ»‘åŠ¨/é•¿æŒ‰ | è°ƒæ•´å‘å°„åŠ›åº¦ | 50% ~ 100% |
| ç‚¹å‡»å‘å°„æŒ‰é’® | å‘å°„å¼¹ç  | - |
| æ¾æ‰‹ï¼ˆå¯é€‰ï¼‰ | è‡ªåŠ¨å‘å°„ | - |

**äº¤äº’ç»†èŠ‚ï¼š**

```typescript
interface LaunchParams {
  angle: number;    // -30 åˆ° +30 åº¦ï¼Œ0 ä¸ºå‚ç›´å‘ä¸‹
  power: number;    // 0.5 åˆ° 1.0ï¼Œå½±å“åˆå§‹é€Ÿåº¦
}

// å‘å°„è§’åº¦å½±å“å¼¹ç åˆå§‹æ°´å¹³é€Ÿåº¦
// å‘å°„åŠ›åº¦å½±å“å¼¹ç åˆå§‹å‚ç›´é€Ÿåº¦
```

### 2.4 æ¸¸æˆæµç¨‹

```
1. ç”¨æˆ·è¿›å…¥æ¸¸æˆé¡µé¢
   â†“
2. ç‚¹å‡»ã€Œå¼€å§‹æ¸¸æˆã€
   â†“
3. è¯·æ±‚æœåŠ¡ç«¯åˆ›å»ºæ¸¸æˆä¼šè¯ â†’ è¿”å› sessionId + seed
   â†“
4. å‰ç«¯åˆå§‹åŒ–ç‰©ç†å¼•æ“ï¼ˆä½¿ç”¨ seedï¼‰
   â†“
5. ç”¨æˆ·å‘å°„ç¬¬ 1 é¢—å¼¹ç 
   â”œâ”€â”€ è°ƒæ•´è§’åº¦/åŠ›åº¦
   â”œâ”€â”€ ç‚¹å‡»å‘å°„
   â”œâ”€â”€ å¼¹ç ç‰©ç†æ¨¡æ‹Ÿ
   â””â”€â”€ è½å…¥æ§½ä½ï¼Œè®°å½•å¾—åˆ†
   â†“
6. é‡å¤æ­¥éª¤ 5ï¼Œå…±å‘å°„ 5 é¢—å¼¹ç 
   â†“
7. æ¸¸æˆç»“æŸï¼Œå±•ç¤ºç»“ç®—ç”»é¢
   â†“
8. æäº¤ç»“æœåˆ°æœåŠ¡ç«¯éªŒè¯
   â†“
9. éªŒè¯é€šè¿‡ â†’ å‘æ”¾ç§¯åˆ†
   â†“
10. å±•ç¤ºç»“ç®—åŠ¨ç”»ï¼ˆéšè—å†·å´ï¼‰
    â†“
11. ç”¨æˆ·å¯é€‰æ‹©ã€Œå†æ¥ä¸€å±€ã€
```

---

## ä¸‰ã€éšè—å¼å†·å´è®¾è®¡

### 3.1 è®¾è®¡ç†å¿µ

ç”¨æˆ·ä¸åº”æ„Ÿå—åˆ°"è¢«é™åˆ¶"ï¼Œå†·å´æ—¶é—´é€šè¿‡è‡ªç„¶çš„ç»“ç®—æµç¨‹æ¶ˆåŒ–ã€‚

### 3.2 ç»“ç®—ç”»é¢æ—¶é—´çº¿

```
æ—¶é—´è½´ï¼ˆç§’ï¼‰
0s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1.5s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2.5s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5s
â”‚              â”‚               â”‚              â”‚             â”‚
â”‚   ç»“ç®—å¼¹çª—   â”‚   ç§¯åˆ†åŠ¨ç”»    â”‚   è¿›åº¦æ¡     â”‚  æŒ‰é’®å‡ºç°   â”‚
â”‚   æ·¡å…¥æ˜¾ç¤º   â”‚   é£å…¥æ•ˆæœ    â”‚   å¡«å……åŠ¨ç”»   â”‚  å¯ç‚¹å‡»     â”‚
â”‚              â”‚               â”‚              â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        æ€»è®¡ 5 ç§’ï¼ˆ= å†·å´æ—¶é—´ï¼‰
```

### 3.3 ç»“ç®—ç”»é¢è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚                      ğŸ‰ æ¸¸æˆç»“æŸï¼                           â”‚
â”‚                                                             â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚                                                 â”‚     â”‚
â”‚     â”‚   ç¬¬1é¢—: 20 åˆ†    â—â”â”â”â”â”â”â”â–¶ [20]              â”‚     â”‚
â”‚     â”‚   ç¬¬2é¢—: 40 åˆ†    â—â”â”â”â”â”â”â”â–¶ [40]              â”‚     â”‚
â”‚     â”‚   ç¬¬3é¢—: 10 åˆ†    â—â”â”â”â”â”â”â”â–¶ [10]              â”‚     â”‚
â”‚     â”‚   ç¬¬4é¢—: 80 åˆ†    â—â”â”â”â”â”â”â”â–¶ [80] â­           â”‚     â”‚
â”‚     â”‚   ç¬¬5é¢—: 20 åˆ†    â—â”â”â”â”â”â”â”â–¶ [20]              â”‚     â”‚
â”‚     â”‚                                                 â”‚     â”‚
â”‚     â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”‚     â”‚
â”‚     â”‚   æœ¬å±€å¾—åˆ†:  170 åˆ†                             â”‚     â”‚
â”‚     â”‚                                                 â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                             â”‚
â”‚              â­ +170 ç§¯åˆ†                                    â”‚
â”‚                 â†‘â†‘â†‘ (ç§¯åˆ†é£å…¥åŠ¨ç”»)                           â”‚
â”‚                                                             â”‚
â”‚     ä»Šæ—¥è¿›åº¦: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 595/1000           â”‚
â”‚                                                             â”‚
â”‚                                                             â”‚
â”‚        [æŸ¥çœ‹æ’è¡Œæ¦œ]              [å†æ¥ä¸€å±€]                  â”‚
â”‚                                 (5ç§’åå¯ç‚¹å‡»)                â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 æé€Ÿç‚¹å‡»å¤„ç†

å¦‚æœç”¨æˆ·åœ¨å†·å´æœªç»“æŸæ—¶ç‚¹å‡»ã€Œå†æ¥ä¸€å±€ã€ï¼š

```typescript
// ä¸æ˜¾ç¤ºå€’è®¡æ—¶ï¼Œä½¿ç”¨è‡ªç„¶çš„åŠ è½½æç¤º
const messages = [
  "å‡†å¤‡å¼¹ç ä¸­...",
  "æ ¡å‡†å‘å°„å™¨...",
  "åŠ è½½æ¸¸æˆåœºæ™¯...",
];

// éšæœºé€‰æ‹©ä¸€ä¸ªæç¤ºï¼Œç­‰å¾…å‰©ä½™å†·å´æ—¶é—´
```

---

## å››ã€é˜²ä½œå¼Šæœºåˆ¶

### 4.1 å¤šå±‚é˜²æŠ¤æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç¬¬ä¸€å±‚ï¼šé¢‘ç‡é™åˆ¶                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ¯å±€æ¸¸æˆæœ€çŸ­æ—¶é•¿ 10 ç§’ï¼ˆ5é¢—å¼¹ç ç‰©ç†ä¸‹è½æ—¶é—´ï¼‰               â”‚
â”‚ â€¢ å±€é—´å¼ºåˆ¶å†·å´ 5 ç§’ï¼ˆé€šè¿‡ç»“ç®—åŠ¨ç”»éšè—ï¼‰                       â”‚
â”‚ â€¢ æ¯æ—¥ç§¯åˆ†ä¸Šé™ 1000ï¼Œè¶…è¿‡ä¸å†å‘æ”¾                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç¬¬äºŒå±‚ï¼šä¼šè¯ç»‘å®š                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. å¼€å§‹æ¸¸æˆ â†’ æœåŠ¡ç«¯ç”Ÿæˆ GameSession                        â”‚
â”‚    { id, oderId, seed, startedAt, expiresAt }               â”‚
â”‚ 2. ä¼šè¯æœ‰æ•ˆæœŸ 5 åˆ†é’Ÿï¼Œè¿‡æœŸè‡ªåŠ¨å¤±æ•ˆ                           â”‚
â”‚ 3. æ¯ä¸ªä¼šè¯åªèƒ½æäº¤ä¸€æ¬¡ç»“æœ                                  â”‚
â”‚ 4. ç”¨æˆ·åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªæ´»è·ƒä¼šè¯                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç¬¬ä¸‰å±‚ï¼šç»“æœæ ¡éªŒ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ åˆ†æ•°èŒƒå›´æ ¡éªŒï¼š0 â‰¤ score â‰¤ 400ï¼ˆ5 Ã— 80ï¼‰                   â”‚
â”‚ â€¢ å¼¹ç æ•°é‡æ ¡éªŒï¼šå¿…é¡»æ°å¥½ 5 é¢—                                â”‚
â”‚ â€¢ æ§½ä½åˆ†å€¼æ ¡éªŒï¼šæ¯é¢—å¿…é¡»æ˜¯ [5,10,20,40,80] ä¹‹ä¸€              â”‚
â”‚ â€¢ æ€»åˆ†ä¸€è‡´æ€§ï¼šballResults ä¹‹å’Œ = score                      â”‚
â”‚ â€¢ æ—¶é•¿æ ¡éªŒï¼šduration â‰¥ 10000ms                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç¬¬å››å±‚ï¼šè¡Œä¸ºåˆ†æï¼ˆå¯é€‰ï¼‰                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ å¼‚å¸¸æ¨¡å¼æ£€æµ‹ï¼šè¿ç»­å¤šå±€æ»¡åˆ†/é«˜åˆ†                            â”‚
â”‚ â€¢ å‘å°„å‚æ•°åˆ†æï¼šè§’åº¦/åŠ›åº¦åˆ†å¸ƒæ˜¯å¦åˆç†                        â”‚
â”‚ â€¢ IP/è®¾å¤‡æŒ‡çº¹ï¼šåŒä¸€æ¥æºå¤§é‡è¯·æ±‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ç¡®å®šæ€§éšæœºç§å­

ä½¿ç”¨æœåŠ¡ç«¯ç”Ÿæˆçš„ seed åˆå§‹åŒ–ç‰©ç†å¼•æ“ï¼Œç¡®ä¿ï¼š
- ç›¸åŒ seed = ç›¸åŒçš„é’‰å­å¾®å°ä½ç½®åç§»
- å¯ç”¨äºæœåŠ¡ç«¯é‡æ”¾éªŒè¯ï¼ˆå¯é€‰ï¼Œæˆæœ¬é«˜ï¼‰

```typescript
import seedrandom from 'seedrandom';

function initPhysicsWorld(seed: string) {
  const rng = seedrandom(seed);
  
  // é’‰å­ä½ç½®çš„å¾®å°éšæœºåç§»ï¼ˆÂ±2pxï¼‰
  pins.forEach(pin => {
    pin.x += (rng() - 0.5) * 4;
    pin.y += (rng() - 0.5) * 4;
  });
}
```

### 4.3 ä¼šè¯ç”Ÿå‘½å‘¨æœŸ

```
åˆ›å»ºä¼šè¯                    æäº¤ç»“æœ                    è¿‡æœŸ
   â”‚                           â”‚                         â”‚
   â–¼                           â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”    æ¸¸æˆä¸­      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NEW  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ PLAYING  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚COMPLETEDâ”‚
â””â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ 5åˆ†é’Ÿæœªæäº¤
                              â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ EXPIRED â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”ã€æ•°æ®æ¨¡å‹

### 5.1 TypeScript ç±»å‹å®šä¹‰

```typescript
// src/lib/types/game.ts

/** æ¸¸æˆç±»å‹ */
export type GameType = 'pachinko';

/** æ¸¸æˆä¼šè¯çŠ¶æ€ */
export type GameSessionStatus = 'playing' | 'completed' | 'expired';

/** æ¸¸æˆä¼šè¯ */
export interface GameSession {
  id: string;
  oderId: number;
  gameType: GameType;
  seed: string;              // éšæœºç§å­
  startedAt: number;         // å¼€å§‹æ—¶é—´æˆ³
  expiresAt: number;         // è¿‡æœŸæ—¶é—´æˆ³ï¼ˆ5åˆ†é’Ÿåï¼‰
  status: GameSessionStatus;
}

/** å¼¹ç å‘å°„å‚æ•° */
export interface BallLaunch {
  angle: number;             // å‘å°„è§’åº¦ (-30 ~ +30)
  power: number;             // å‘å°„åŠ›åº¦ (0.5 ~ 1.0)
  slotScore: number;         // è½å…¥æ§½ä½åˆ†æ•°
  duration: number;          // è¯¥å¼¹ç ä»å‘å°„åˆ°è½æ§½çš„æ—¶é—´(ms)
}

/** æ¸¸æˆç»“æœæäº¤ */
export interface GameResultSubmit {
  sessionId: string;
  score: number;             // æ€»å¾—åˆ†
  duration: number;          // æ€»æ¸¸æˆæ—¶é•¿(ms)
  balls: BallLaunch[];       // æ¯é¢—å¼¹ç çš„è¯¦ç»†æ•°æ®
}

/** æ¸¸æˆè®°å½• */
export interface GameRecord {
  id: string;
  oderId: number;
  sessionId: string;
  gameType: GameType;
  score: number;             // æ¸¸æˆå¾—åˆ†
  pointsEarned: number;      // å®é™…è·å¾—ç§¯åˆ†ï¼ˆå¯èƒ½å› ä¸Šé™è¢«æˆªæ–­ï¼‰
  duration: number;          // æ¸¸æˆæ—¶é•¿
  balls: number[];           // æ¯é¢—å¼¹ç å¾—åˆ† [20, 40, 10, 80, 20]
  createdAt: number;
}

/** æ¯æ—¥ç»Ÿè®¡ */
export interface DailyGameStats {
  oderId: number;
  date: string;              // YYYY-MM-DD
  gamesPlayed: number;       // ä»Šæ—¥æ¸¸æˆå±€æ•°
  totalScore: number;        // ä»Šæ—¥æ€»å¾—åˆ†
  pointsEarned: number;      // ä»Šæ—¥å·²è·ç§¯åˆ†
  lastGameAt: number;        // æœ€åä¸€å±€æ—¶é—´æˆ³
}
```

### 5.2 Vercel KV é”®å€¼è®¾è®¡

| Key Pattern | Value Type | è¯´æ˜ | TTL |
|-------------|------------|------|-----|
| `game:session:{sessionId}` | `GameSession` | æ¸¸æˆä¼šè¯ | 5åˆ†é’Ÿ |
| `game:active:{oderId}` | `string` | ç”¨æˆ·å½“å‰æ´»è·ƒä¼šè¯ID | 5åˆ†é’Ÿ |
| `game:daily:{oderId}:{date}` | `DailyGameStats` | æ¯æ—¥ç»Ÿè®¡ | 48å°æ—¶ |
| `game:records:{oderId}` | `List<GameRecord>` | æ¸¸æˆè®°å½•ï¼ˆæœ€è¿‘50æ¡ï¼‰ | - |
| `game:cooldown:{oderId}` | `1` | å†·å´æ ‡è®° | 5ç§’ |
| `game:leaderboard:daily:{date}` | `SortedSet` | æ¯æ—¥æ’è¡Œæ¦œ | 48å°æ—¶ |
| `game:leaderboard:total` | `SortedSet` | æ€»ç§¯åˆ†æ’è¡Œæ¦œ | - |

---

## å…­ã€æ ¸å¿ƒæœåŠ¡

### 6.1 æ¸¸æˆæœåŠ¡ game.ts

```typescript
// src/lib/game.ts

import { kv } from '@vercel/kv';
import { nanoid } from 'nanoid';
import crypto from 'crypto';
import type {
  GameSession,
  GameResultSubmit,
  GameRecord,
  DailyGameStats,
} from './types/game';
import { addPoints } from './points';

// ============ å¸¸é‡é…ç½® ============
const DAILY_POINTS_LIMIT = 1000;
const SESSION_TTL = 5 * 60;        // 5åˆ†é’Ÿ
const COOLDOWN_TTL = 5;            // 5ç§’
const MIN_GAME_DURATION = 10000;   // 10ç§’
const BALLS_PER_GAME = 5;
const VALID_SLOT_SCORES = [5, 10, 20, 40, 80];
const MAX_POSSIBLE_SCORE = BALLS_PER_GAME * 80; // 400

// ============ Key ç”Ÿæˆå™¨ ============
const SESSION_KEY = (id: string) => `game:session:${id}`;
const ACTIVE_KEY = (oderId: number) => `game:active:${oderId}`;
const DAILY_KEY = (oderId: number, date: string) => `game:daily:${oderId}:${date}`;
const RECORDS_KEY = (oderId: number) => `game:records:${oderId}`;
const COOLDOWN_KEY = (oderId: number) => `game:cooldown:${oderId}`;

// ============ å·¥å…·å‡½æ•° ============
function getTodayDateString(): string {
  const now = new Date();
  const chinaTime = new Date(now.getTime() + 8 * 60 * 60 * 1000);
  return chinaTime.toISOString().slice(0, 10);
}

function generateSeed(): string {
  return crypto.randomBytes(16).toString('hex');
}

// ============ ä¼šè¯ç®¡ç† ============

/**
 * å¼€å§‹æ–°æ¸¸æˆ
 */
export async function startGame(oderId: number): Promise<{
  success: boolean;
  session?: GameSession;
  error?: string;
}> {
  // 1. æ£€æŸ¥å†·å´
  const cooldown = await kv.get(COOLDOWN_KEY(oderId));
  if (cooldown) {
    return { success: false, error: 'è¯·ç¨åå†è¯•' };
  }

  // 2. æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒä¼šè¯
  const activeSessionId = await kv.get<string>(ACTIVE_KEY(oderId));
  if (activeSessionId) {
    // å°†æ—§ä¼šè¯æ ‡è®°ä¸ºè¿‡æœŸ
    await kv.del(SESSION_KEY(activeSessionId));
  }

  // 3. æ£€æŸ¥æ¯æ—¥ç§¯åˆ†ä¸Šé™
  const today = getTodayDateString();
  const dailyStats = await kv.get<DailyGameStats>(DAILY_KEY(oderId, today));
  if (dailyStats && dailyStats.pointsEarned >= DAILY_POINTS_LIMIT) {
    return { success: false, error: 'ä»Šæ—¥ç§¯åˆ†å·²è¾¾ä¸Šé™' };
  }

  // 4. åˆ›å»ºæ–°ä¼šè¯
  const now = Date.now();
  const session: GameSession = {
    id: nanoid(),
    oderId,
    gameType: 'pachinko',
    seed: generateSeed(),
    startedAt: now,
    expiresAt: now + SESSION_TTL * 1000,
    status: 'playing',
  };

  // 5. ä¿å­˜ä¼šè¯
  await kv.set(SESSION_KEY(session.id), session, { ex: SESSION_TTL });
  await kv.set(ACTIVE_KEY(oderId), session.id, { ex: SESSION_TTL });

  return { success: true, session };
}

/**
 * æäº¤æ¸¸æˆç»“æœ
 */
export async function submitGameResult(
  oderId: number,
  result: GameResultSubmit
): Promise<{
  success: boolean;
  pointsEarned?: number;
  dailyTotal?: number;
  dailyRemaining?: number;
  error?: string;
}> {
  // 1. è·å–å¹¶éªŒè¯ä¼šè¯
  const session = await kv.get<GameSession>(SESSION_KEY(result.sessionId));
  
  if (!session) {
    return { success: false, error: 'æ¸¸æˆä¼šè¯ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ' };
  }
  
  if (session.oderId !== oderId) {
    return { success: false, error: 'ä¼šè¯ä¸å±äºå½“å‰ç”¨æˆ·' };
  }
  
  if (session.status !== 'playing') {
    return { success: false, error: 'æ¸¸æˆå·²ç»“æŸ' };
  }

  // 2. éªŒè¯æ¸¸æˆç»“æœ
  const validation = validateGameResult(result);
  if (!validation.valid) {
    return { success: false, error: validation.reason };
  }

  // 3. æ ‡è®°ä¼šè¯ä¸ºå·²å®Œæˆï¼ˆåŸå­æ“ä½œé˜²é‡å¤æäº¤ï¼‰
  const updated = await kv.set(
    SESSION_KEY(result.sessionId),
    { ...session, status: 'completed' },
    { ex: 60, xx: true } // XX: åªåœ¨ key å­˜åœ¨æ—¶è®¾ç½®
  );
  
  if (!updated) {
    return { success: false, error: 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•' };
  }

  // 4. è®¡ç®—å¯è·å¾—ç§¯åˆ†
  const today = getTodayDateString();
  const dailyStats = await kv.get<DailyGameStats>(DAILY_KEY(oderId, today)) || {
    oderId,
    date: today,
    gamesPlayed: 0,
    totalScore: 0,
    pointsEarned: 0,
    lastGameAt: 0,
  };

  const remaining = DAILY_POINTS_LIMIT - dailyStats.pointsEarned;
  const pointsToEarn = Math.min(result.score, remaining);

  // 5. å‘æ”¾ç§¯åˆ†
  if (pointsToEarn > 0) {
    await addPoints(
      oderId,
      pointsToEarn,
      'game_play',
      `å¼¹ç æœºæ¸¸æˆ: ${result.score}åˆ†`
    );
  }

  // 6. æ›´æ–°æ¯æ—¥ç»Ÿè®¡
  const newDailyStats: DailyGameStats = {
    ...dailyStats,
    gamesPlayed: dailyStats.gamesPlayed + 1,
    totalScore: dailyStats.totalScore + result.score,
    pointsEarned: dailyStats.pointsEarned + pointsToEarn,
    lastGameAt: Date.now(),
  };
  await kv.set(DAILY_KEY(oderId, today), newDailyStats, { ex: 48 * 60 * 60 });

  // 7. ä¿å­˜æ¸¸æˆè®°å½•
  const record: GameRecord = {
    id: nanoid(),
    oderId,
    sessionId: result.sessionId,
    gameType: 'pachinko',
    score: result.score,
    pointsEarned: pointsToEarn,
    duration: result.duration,
    balls: result.balls.map(b => b.slotScore),
    createdAt: Date.now(),
  };
  await kv.lpush(RECORDS_KEY(oderId), record);
  await kv.ltrim(RECORDS_KEY(oderId), 0, 49); // ä¿ç•™æœ€è¿‘50æ¡

  // 8. è®¾ç½®å†·å´
  await kv.set(COOLDOWN_KEY(oderId), 1, { ex: COOLDOWN_TTL });

  // 9. æ¸…ç†æ´»è·ƒä¼šè¯æ ‡è®°
  await kv.del(ACTIVE_KEY(oderId));

  return {
    success: true,
    pointsEarned: pointsToEarn,
    dailyTotal: newDailyStats.pointsEarned,
    dailyRemaining: DAILY_POINTS_LIMIT - newDailyStats.pointsEarned,
  };
}

/**
 * éªŒè¯æ¸¸æˆç»“æœ
 */
function validateGameResult(result: GameResultSubmit): {
  valid: boolean;
  reason?: string;
} {
  // 1. æ—¶é•¿æ ¡éªŒ
  if (result.duration < MIN_GAME_DURATION) {
    return { valid: false, reason: 'æ¸¸æˆæ—¶é—´å¼‚å¸¸' };
  }

  // 2. åˆ†æ•°èŒƒå›´æ ¡éªŒ
  if (result.score < 0 || result.score > MAX_POSSIBLE_SCORE) {
    return { valid: false, reason: 'åˆ†æ•°å¼‚å¸¸' };
  }

  // 3. å¼¹ç æ•°é‡æ ¡éªŒ
  if (result.balls.length !== BALLS_PER_GAME) {
    return { valid: false, reason: 'å¼¹ç æ•°é‡å¼‚å¸¸' };
  }

  // 4. æ¯é¢—å¼¹ç åˆ†æ•°åˆæ³•æ€§
  for (const ball of result.balls) {
    if (!VALID_SLOT_SCORES.includes(ball.slotScore)) {
      return { valid: false, reason: 'æ§½ä½åˆ†æ•°å¼‚å¸¸' };
    }
    // å‘å°„å‚æ•°æ ¡éªŒ
    if (ball.angle < -30 || ball.angle > 30) {
      return { valid: false, reason: 'å‘å°„è§’åº¦å¼‚å¸¸' };
    }
    if (ball.power < 0.5 || ball.power > 1.0) {
      return { valid: false, reason: 'å‘å°„åŠ›åº¦å¼‚å¸¸' };
    }
  }

  // 5. æ€»åˆ†ä¸€è‡´æ€§
  const sum = result.balls.reduce((acc, b) => acc + b.slotScore, 0);
  if (sum !== result.score) {
    return { valid: false, reason: 'åˆ†æ•°è®¡ç®—å¼‚å¸¸' };
  }

  return { valid: true };
}

// ============ æŸ¥è¯¢æ¥å£ ============

/**
 * è·å–ç”¨æˆ·ä»Šæ—¥æ¸¸æˆç»Ÿè®¡
 */
export async function getDailyStats(oderId: number): Promise<DailyGameStats | null> {
  const today = getTodayDateString();
  return await kv.get<DailyGameStats>(DAILY_KEY(oderId, today));
}

/**
 * è·å–ç”¨æˆ·æ¸¸æˆè®°å½•
 */
export async function getGameRecords(
  oderId: number,
  limit = 20
): Promise<GameRecord[]> {
  return (await kv.lrange<GameRecord>(RECORDS_KEY(oderId), 0, limit - 1)) ?? [];
}

/**
 * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨å†·å´ä¸­
 */
export async function isInCooldown(oderId: number): Promise<boolean> {
  const cooldown = await kv.get(COOLDOWN_KEY(oderId));
  return !!cooldown;
}

/**
 * è·å–å†·å´å‰©ä½™æ—¶é—´ï¼ˆç§’ï¼‰
 */
export async function getCooldownRemaining(oderId: number): Promise<number> {
  const ttl = await kv.ttl(COOLDOWN_KEY(oderId));
  return ttl > 0 ? ttl : 0;
}
```

---

## ä¸ƒã€API è·¯ç”±è®¾è®¡

### 7.1 è·¯ç”±æ€»è§ˆ

| è·¯ç”± | æ–¹æ³• | è¯´æ˜ | æƒé™ |
|------|------|------|------|
| `/api/games/pachinko/start` | POST | å¼€å§‹æ¸¸æˆ | ç”¨æˆ· |
| `/api/games/pachinko/submit` | POST | æäº¤ç»“æœ | ç”¨æˆ· |
| `/api/games/pachinko/status` | GET | è·å–çŠ¶æ€ | ç”¨æˆ· |
| `/api/games/records` | GET | è·å–è®°å½• | ç”¨æˆ· |

### 7.2 API è¯¦ç»†è¯´æ˜

#### POST /api/games/pachinko/start

å¼€å§‹æ–°æ¸¸æˆï¼Œè·å–ä¼šè¯IDå’Œéšæœºç§å­ã€‚

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": {
    "sessionId": "abc123xyz",
    "seed": "a1b2c3d4e5f6...",
    "expiresAt": 1705826700000
  }
}
```

**é”™è¯¯å“åº”ï¼š**
```json
{
  "success": false,
  "error": "ä»Šæ—¥ç§¯åˆ†å·²è¾¾ä¸Šé™"
}
```

#### POST /api/games/pachinko/submit

æäº¤æ¸¸æˆç»“æœã€‚

**è¯·æ±‚ä½“ï¼š**
```json
{
  "sessionId": "abc123xyz",
  "score": 170,
  "duration": 45000,
  "balls": [
    { "angle": -5, "power": 0.8, "slotScore": 20, "duration": 3500 },
    { "angle": 10, "power": 0.9, "slotScore": 40, "duration": 4200 },
    { "angle": -15, "power": 0.7, "slotScore": 10, "duration": 3800 },
    { "angle": 0, "power": 1.0, "slotScore": 80, "duration": 5100 },
    { "angle": 5, "power": 0.85, "slotScore": 20, "duration": 4000 }
  ]
}
```

**æˆåŠŸå“åº”ï¼š**
```json
{
  "success": true,
  "data": {
    "pointsEarned": 170,
    "dailyTotal": 595,
    "dailyRemaining": 405
  }
}
```

#### GET /api/games/pachinko/status

è·å–å½“å‰æ¸¸æˆçŠ¶æ€ã€‚

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": {
    "dailyStats": {
      "gamesPlayed": 5,
      "totalScore": 520,
      "pointsEarned": 520,
      "remaining": 480
    },
    "cooldown": {
      "active": false,
      "remaining": 0
    },
    "canPlay": true
  }
}
```

#### GET /api/games/records

è·å–æ¸¸æˆè®°å½•ã€‚

**æŸ¥è¯¢å‚æ•°ï¼š**
- `limit`: è¿”å›æ¡æ•°ï¼Œé»˜è®¤ 20

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": {
    "records": [
      {
        "id": "rec_001",
        "score": 170,
        "pointsEarned": 170,
        "balls": [20, 40, 10, 80, 20],
        "createdAt": 1705826400000
      }
    ]
  }
}
```

---

## å…«ã€å‰ç«¯æŠ€æœ¯æ–¹æ¡ˆ

### 8.1 æŠ€æœ¯æ ˆ

| ç”¨é€” | æŠ€æœ¯ | è¯´æ˜ |
|------|------|------|
| ç‰©ç†å¼•æ“ | Matter.js | è½»é‡çº§ 2D ç‰©ç† |
| ç¡®å®šæ€§éšæœº | seedrandom | ä¿è¯ç›¸åŒç§å­ç›¸åŒç»“æœ |
| åŠ¨ç”» | Framer Motion | ç»“ç®—åŠ¨ç”» |
| éŸ³æ•ˆ | Howler.js | å¯é€‰ |

### 8.2 æ–‡ä»¶ç»“æ„

```
src/app/games/
â”œâ”€â”€ page.tsx                    # æ¸¸æˆå¤§å…
â””â”€â”€ pachinko/
    â”œâ”€â”€ page.tsx                # å¼¹ç æœºé¡µé¢
    â”œâ”€â”€ components/
    â”‚   â”œâ”€â”€ GameBoard.tsx       # æ¸¸æˆç”»å¸ƒ
    â”‚   â”œâ”€â”€ LaunchControl.tsx   # å‘å°„æ§åˆ¶å™¨
    â”‚   â”œâ”€â”€ ScoreDisplay.tsx    # åˆ†æ•°æ˜¾ç¤º
    â”‚   â”œâ”€â”€ ResultModal.tsx     # ç»“ç®—å¼¹çª—
    â”‚   â””â”€â”€ Ball.tsx            # å¼¹ç ç»„ä»¶
    â”œâ”€â”€ hooks/
    â”‚   â”œâ”€â”€ useGameEngine.ts    # ç‰©ç†å¼•æ“ Hook
    â”‚   â””â”€â”€ useGameSession.ts   # ä¼šè¯ç®¡ç† Hook
    â””â”€â”€ lib/
        â”œâ”€â”€ physics.ts          # ç‰©ç†é…ç½®
        â””â”€â”€ constants.ts        # æ¸¸æˆå¸¸é‡
```

### 8.3 ç‰©ç†å¼•æ“é…ç½®

```typescript
// src/app/games/pachinko/lib/physics.ts

import Matter from 'matter-js';
import seedrandom from 'seedrandom';

export interface PhysicsConfig {
  width: number;
  height: number;
  seed: string;
}

export function createGameWorld(config: PhysicsConfig) {
  const { Engine, World, Bodies, Body } = Matter;
  const rng = seedrandom(config.seed);
  
  const engine = Engine.create();
  engine.gravity.y = 1; // é‡åŠ›
  
  // åˆ›å»ºè¾¹ç•Œ
  const walls = [
    Bodies.rectangle(config.width / 2, -10, config.width, 20, { isStatic: true }),
    Bodies.rectangle(config.width / 2, config.height + 10, config.width, 20, { isStatic: true }),
    Bodies.rectangle(-10, config.height / 2, 20, config.height, { isStatic: true }),
    Bodies.rectangle(config.width + 10, config.height / 2, 20, config.height, { isStatic: true }),
  ];
  
  // åˆ›å»ºé’‰å­ï¼ˆ8å±‚ï¼Œäº¤é”™æ’åˆ—ï¼‰
  const pins: Matter.Body[] = [];
  const pinRadius = 5;
  const startY = 100;
  const rowSpacing = 40;
  const colSpacing = 40;
  
  for (let row = 0; row < 8; row++) {
    const isOffset = row % 2 === 1;
    const cols = isOffset ? 8 : 9;
    const startX = isOffset ? colSpacing : colSpacing / 2;
    
    for (let col = 0; col < cols; col++) {
      // ä½¿ç”¨ seed ç”Ÿæˆå¾®å°åç§»
      const offsetX = (rng() - 0.5) * 4;
      const offsetY = (rng() - 0.5) * 4;
      
      const pin = Bodies.circle(
        startX + col * colSpacing + offsetX,
        startY + row * rowSpacing + offsetY,
        pinRadius,
        { isStatic: true, restitution: 0.5, label: 'pin' }
      );
      pins.push(pin);
    }
  }
  
  // åˆ›å»ºæ§½ä½åˆ†éš”æ¿
  const slotDividers: Matter.Body[] = [];
  const slotScores = [5, 10, 20, 40, 80, 40, 20, 10, 5];
  const slotWidth = config.width / slotScores.length;
  const slotY = config.height - 30;
  
  for (let i = 0; i <= slotScores.length; i++) {
    const divider = Bodies.rectangle(
      i * slotWidth,
      slotY,
      4,
      60,
      { isStatic: true, label: 'divider' }
    );
    slotDividers.push(divider);
  }
  
  // åˆ›å»ºæ§½ä½ä¼ æ„Ÿå™¨ï¼ˆç”¨äºæ£€æµ‹å¼¹ç è½å…¥ï¼‰
  const slotSensors = slotScores.map((score, i) => {
    return Bodies.rectangle(
      i * slotWidth + slotWidth / 2,
      config.height - 10,
      slotWidth - 8,
      20,
      { 
        isStatic: true, 
        isSensor: true, 
        label: `slot_${score}`,
        // è‡ªå®šä¹‰å±æ€§
        // @ts-ignore
        slotScore: score,
      }
    );
  });
  
  World.add(engine.world, [...walls, ...pins, ...slotDividers, ...slotSensors]);
  
  return {
    engine,
    slotScores,
    
    // åˆ›å»ºå¼¹ç 
    createBall: (x: number, angle: number, power: number) => {
      const ball = Bodies.circle(x, 30, 10, {
        restitution: 0.6,
        friction: 0.001,
        label: 'ball',
      });
      
      // æ ¹æ®è§’åº¦å’ŒåŠ›åº¦è®¾ç½®åˆå§‹é€Ÿåº¦
      const radians = (angle * Math.PI) / 180;
      const speed = 5 + power * 10; // åŸºç¡€é€Ÿåº¦ + åŠ›åº¦åŠ æˆ
      
      Body.setVelocity(ball, {
        x: Math.sin(radians) * speed,
        y: Math.cos(radians) * speed,
      });
      
      World.add(engine.world, ball);
      return ball;
    },
    
    // ç§»é™¤å¼¹ç 
    removeBall: (ball: Matter.Body) => {
      World.remove(engine.world, ball);
    },
  };
}
```

### 8.4 æ¸¸æˆæ ¸å¿ƒ Hook

```typescript
// src/app/games/pachinko/hooks/useGameEngine.ts

import { useCallback, useEffect, useRef, useState } from 'react';
import Matter from 'matter-js';
import { createGameWorld } from '../lib/physics';

interface BallResult {
  angle: number;
  power: number;
  slotScore: number;
  duration: number;
}

interface GameState {
  status: 'idle' | 'playing' | 'launching' | 'waiting' | 'finished';
  ballsRemaining: number;
  currentScore: number;
  ballResults: BallResult[];
  launchParams: { angle: number; power: number };
}

export function useGameEngine(seed: string | null) {
  const engineRef = useRef<ReturnType<typeof createGameWorld> | null>(null);
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const [gameState, setGameState] = useState<GameState>({
    status: 'idle',
    ballsRemaining: 5,
    currentScore: 0,
    ballResults: [],
    launchParams: { angle: 0, power: 0.75 },
  });
  
  // åˆå§‹åŒ–å¼•æ“
  useEffect(() => {
    if (!seed || !canvasRef.current) return;
    
    const world = createGameWorld({
      width: canvasRef.current.width,
      height: canvasRef.current.height,
      seed,
    });
    
    engineRef.current = world;
    
    // ç¢°æ’æ£€æµ‹
    Matter.Events.on(world.engine, 'collisionStart', (event) => {
      event.pairs.forEach((pair) => {
        const { bodyA, bodyB } = pair;
        
        // æ£€æµ‹å¼¹ç è½å…¥æ§½ä½
        if (bodyA.label === 'ball' && bodyB.label.startsWith('slot_')) {
          const score = (bodyB as any).slotScore;
          handleBallLanded(bodyA, score);
        }
        if (bodyB.label === 'ball' && bodyA.label.startsWith('slot_')) {
          const score = (bodyA as any).slotScore;
          handleBallLanded(bodyB, score);
        }
      });
    });
    
    // æ¸²æŸ“å¾ªç¯
    const render = () => {
      if (!canvasRef.current) return;
      Matter.Engine.update(world.engine, 1000 / 60);
      drawWorld(canvasRef.current, world);
      requestAnimationFrame(render);
    };
    render();
    
    return () => {
      Matter.Engine.clear(world.engine);
    };
  }, [seed]);
  
  // å¤„ç†å¼¹ç è½æ§½
  const handleBallLanded = useCallback((ball: Matter.Body, score: number) => {
    // è®¡ç®—è¯¥å¼¹ç çš„é£è¡Œæ—¶é—´
    const duration = Date.now() - launchTimeRef.current;
    
    setGameState(prev => {
      const newResult: BallResult = {
        angle: prev.launchParams.angle,
        power: prev.launchParams.power,
        slotScore: score,
        duration,
      };
      
      const newResults = [...prev.ballResults, newResult];
      const newScore = prev.currentScore + score;
      const newRemaining = prev.ballsRemaining - 1;
      
      return {
        ...prev,
        status: newRemaining > 0 ? 'waiting' : 'finished',
        ballsRemaining: newRemaining,
        currentScore: newScore,
        ballResults: newResults,
      };
    });
    
    // ç§»é™¤å¼¹ç 
    if (engineRef.current) {
      engineRef.current.removeBall(ball);
    }
  }, []);
  
  const launchTimeRef = useRef<number>(0);
  
  // å‘å°„å¼¹ç 
  const launchBall = useCallback(() => {
    if (!engineRef.current || gameState.status === 'launching') return;
    
    const { angle, power } = gameState.launchParams;
    const startX = canvasRef.current!.width / 2;
    
    launchTimeRef.current = Date.now();
    engineRef.current.createBall(startX, angle, power);
    
    setGameState(prev => ({ ...prev, status: 'launching' }));
  }, [gameState.launchParams, gameState.status]);
  
  // æ›´æ–°å‘å°„å‚æ•°
  const setLaunchParams = useCallback((params: Partial<{ angle: number; power: number }>) => {
    setGameState(prev => ({
      ...prev,
      launchParams: { ...prev.launchParams, ...params },
    }));
  }, []);
  
  // å¼€å§‹æ¸¸æˆ
  const startGame = useCallback(() => {
    setGameState({
      status: 'playing',
      ballsRemaining: 5,
      currentScore: 0,
      ballResults: [],
      launchParams: { angle: 0, power: 0.75 },
    });
  }, []);
  
  return {
    canvasRef,
    gameState,
    launchBall,
    setLaunchParams,
    startGame,
  };
}

// ç»˜åˆ¶å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼‰
function drawWorld(canvas: HTMLCanvasElement, world: ReturnType<typeof createGameWorld>) {
  const ctx = canvas.getContext('2d')!;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // ç»˜åˆ¶æ‰€æœ‰ç‰©ä½“...
  const bodies = Matter.Composite.allBodies(world.engine.world);
  bodies.forEach(body => {
    // æ ¹æ® label ä½¿ç”¨ä¸åŒæ ·å¼ç»˜åˆ¶
    // ...
  });
}
```

---

## ä¹ã€å®æ–½ä»»åŠ¡æ¸…å•

### P0 - æ ¸å¿ƒåŠŸèƒ½

| # | ä»»åŠ¡ | æ–‡ä»¶è·¯å¾„ | é¢„ä¼° |
|---|------|----------|------|
| 1 | æ¸¸æˆç±»å‹å®šä¹‰ | `src/lib/types/game.ts` | 0.5h |
| 2 | æ¸¸æˆæœåŠ¡ | `src/lib/game.ts` | 2h |
| 3 | å¼€å§‹æ¸¸æˆ API | `src/app/api/games/pachinko/start/route.ts` | 0.5h |
| 4 | æäº¤ç»“æœ API | `src/app/api/games/pachinko/submit/route.ts` | 1h |
| 5 | æ¸¸æˆçŠ¶æ€ API | `src/app/api/games/pachinko/status/route.ts` | 0.5h |
| 6 | ç‰©ç†å¼•æ“é…ç½® | `src/app/games/pachinko/lib/physics.ts` | 2h |
| 7 | æ¸¸æˆæ ¸å¿ƒ Hook | `src/app/games/pachinko/hooks/useGameEngine.ts` | 2h |
| 8 | æ¸¸æˆç”»å¸ƒç»„ä»¶ | `src/app/games/pachinko/components/GameBoard.tsx` | 2h |
| 9 | å‘å°„æ§åˆ¶ç»„ä»¶ | `src/app/games/pachinko/components/LaunchControl.tsx` | 1h |
| 10 | å¼¹ç æœºä¸»é¡µé¢ | `src/app/games/pachinko/page.tsx` | 2h |

### P1 - ä½“éªŒä¼˜åŒ–

| # | ä»»åŠ¡ | æ–‡ä»¶è·¯å¾„ | é¢„ä¼° |
|---|------|----------|------|
| 11 | ç»“ç®—å¼¹çª—ç»„ä»¶ | `src/app/games/pachinko/components/ResultModal.tsx` | 1.5h |
| 12 | ç§¯åˆ†é£å…¥åŠ¨ç”» | ç»“ç®—ç»„ä»¶å†… | 1h |
| 13 | æ¸¸æˆå¤§å…é¡µé¢ | `src/app/games/page.tsx` | 1h |
| 14 | æ¸¸æˆè®°å½• API | `src/app/api/games/records/route.ts` | 0.5h |
| 15 | é¦–é¡µå…¥å£æ•´åˆ | `src/app/page.tsx` | 0.5h |

### P2 - å¢å¼ºåŠŸèƒ½

| # | ä»»åŠ¡ | æ–‡ä»¶è·¯å¾„ | é¢„ä¼° |
|---|------|----------|------|
| 16 | éŸ³æ•ˆç³»ç»Ÿ | - | 1h |
| 17 | æ’è¡Œæ¦œåŠŸèƒ½ | - | 2h |
| 18 | æˆå°±ç³»ç»Ÿï¼ˆå¯é€‰ï¼‰ | - | - |

---

## åã€é™„å½•

### A. Matter.js å®‰è£…

```bash
npm install matter-js
npm install -D @types/matter-js
npm install seedrandom
npm install -D @types/seedrandom
```

### B. æ¸¸æˆå¸¸é‡é…ç½®

```typescript
// src/app/games/pachinko/lib/constants.ts

export const GAME_CONFIG = {
  // æ¸¸æˆè§„åˆ™
  BALLS_PER_GAME: 5,
  DAILY_POINTS_LIMIT: 1000,
  MIN_GAME_DURATION: 10000, // 10ç§’
  SESSION_TTL: 300, // 5åˆ†é’Ÿ
  COOLDOWN_TTL: 5, // 5ç§’
  
  // æ§½ä½åˆ†å€¼
  SLOT_SCORES: [5, 10, 20, 40, 80, 40, 20, 10, 5],
  
  // å‘å°„å‚æ•°èŒƒå›´
  ANGLE_RANGE: { min: -30, max: 30 },
  POWER_RANGE: { min: 0.5, max: 1.0 },
  
  // ç”»å¸ƒå°ºå¯¸
  CANVAS_WIDTH: 360,
  CANVAS_HEIGHT: 640,
  
  // ç‰©ç†å‚æ•°
  BALL_RADIUS: 10,
  PIN_RADIUS: 5,
  GRAVITY: 1,
  BALL_RESTITUTION: 0.6,
  PIN_RESTITUTION: 0.5,
};
```

### C. ä¸ç§¯åˆ†å•†åº—å¯¹æ¥

å¼¹ç æœºæ¸¸æˆé€šè¿‡ `addPoints()` å‡½æ•°ä¸ç§¯åˆ†ç³»ç»Ÿå¯¹æ¥ï¼š

```typescript
import { addPoints } from '@/lib/points';

// æ¸¸æˆç»“æŸåå‘æ”¾ç§¯åˆ†
await addPoints(
  oderId,
  pointsToEarn,
  'game_play',           // ç§¯åˆ†æ¥æºç±»å‹
  `å¼¹ç æœºæ¸¸æˆ: ${score}åˆ†` // æè¿°
);
```

ç§¯åˆ†æ¥æºç±»å‹ `game_play` å·²åœ¨ `points-store-design.md` ä¸­å®šä¹‰ã€‚

---

## åä¸€ã€æ›´æ–°æ—¥å¿—

| ç‰ˆæœ¬ | æ—¥æœŸ | å†…å®¹ |
|------|------|------|
| 1.0 | 2026-01-21 | åˆå§‹ç‰ˆæœ¬ |
